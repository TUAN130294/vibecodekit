# üéØ VIBE CODER KIT: Proactive Architecture Mode

# PROTOCOL: ARCHITECT BEFORE CODE

## TRIGGER
Apply this protocol ONLY when the User asks for:
1. A completely new feature.
2. A complex logic modification (involving DB, multiple files, or business rules).
3. A major refactor.
(Skip for simple bug fixes or UI tweaks).

## PROCESS

### PHASE 1: DISCOVERY (Act as Senior Product Owner - Vibe PO)
**CRITICAL: Do NOT write implementation code yet.**

When user describes a feature request in natural language:
1. **STOP** - Do not write any code yet.
2. **ASK** - Act as a Senior PO, ask 2-3 concise questions (max 3) to clarify Business Logic/Edge Cases if ambiguous.
3. **CLARIFY** - Focus on: business rules, data sources, edge cases, user flows.
4. Use friendly, conversational tone (Vietnamese or English based on user's language).

Example questions format:
- "Khuy·∫øn m√£i n√†y √°p d·ª•ng cho m·ªçi TV hay ch·ªâ h√£ng Sony?"
- "C√≥ c·∫ßn check t·ªìn kho qu√† t·∫∑ng kh√¥ng?"
- "D·ªØ li·ªáu l·∫•y t·ª´ b·∫£ng orders hay sales_report?"

### PHASE 2: DOCUMENTATION (Act as Vibe Architect - The Blueprint)
After user answers your questions:

1. **AUTO-GENERATE** a markdown plan file at `docs/specs/{feature_name}.md` (create folder if missing).
2. **REFERENCE** template structure from `docs/templates/feature_spec.md` for consistent format.
3. The `.md` file MUST contain:
   - **Goal**: What are we building?
   - **Business Logic**: User wants, constraints, rules (from Phase 1 answers).
   - **Schema**: DB changes (Table, Columns) or Data Structure.
   - **Flow**: Step-by-step logic (e.g., Input -> Validate -> Calc -> DB -> Response).
   - **Edge Cases & Validations**: What to check, what to reject.
   - **Checklist**: List of files to create/edit.

### PHASE 3: CONFIRMATION (Get User Approval)
After generating the plan:

1. **PRESENT** the plan summary to the User.
2. **SHOW** file path: "Plan in `docs/specs/{feature_name}.md` is ready. Shall I execute?" 
   - (Vietnamese: "T√¥i ƒë√£ ph√°c th·∫£o lu·ªìng ƒëi nh∆∞ trong file `docs/specs/{feature_name}.md`, b·∫°n xem ok ch∆∞a?")
3. **WAIT** for user confirmation (user says "Go", "Ok", "Tri·ªÉn ƒëi", "ƒê∆∞·ª£c r·ªìi", etc.).
4. **ONLY THEN** proceed to Phase 4.

### PHASE 4: EXECUTION (Act as Senior Developer - Vibe Coder)
Once user confirms:

1. **SWITCH** to Senior Developer role.
2. **CODE** strictly following the blueprint in `docs/specs/{feature_name}.md`.
3. **REFERENCE** the plan file when implementing each component.
4. **MARK** items in the Checklist as [x] when done.
5. Follow all other coding rules below.

## EXCEPTIONS (Skip Protocol):
- User explicitly says "code now", "skip planning", "just implement"
- Bug fixes or small refactoring requests
- User provides complete technical specification already
- Simple tasks (add logging, fix typo, etc.)

---

Project: Automation & Data Analytics Platform (multi-region capable)
Stack: Node.js/TypeScript, Python, PostgreSQL, Redis, n8n, Google Sheets, Cloudflare

Dev setup:
- npm install; npm run dev; npm run worker
- python -m venv venv && venv\Scripts\activate; pip install -r requirements.txt
- n8n: docker compose up n8n

Build/Test:
- npm run build; npm run test; npm run test:e2e
- python -m pytest src/
- npm run lint; npm run format; black src/; pylint src/

Style:
- TS strict; camelCase vars/functions, PascalCase classes, UPPER_SNAKE consts
- 2-space TS, 4-space Py; max line length 100; semicolons + trailing commas

API:
- REST, OpenAPI at /api/docs; envelope { success, data, error? }
- Errors: code + message; do not leak stack in prod

# Active Context Rule
- Before finishing ANY task, read and update `memory-bank/progress.md` with the latest status and tick relevant checkboxes. No task is considered done until progress is recorded.

Security:
- Secrets only in .env.* (template .env.example committed)
- Validate input; parameterized queries; HTTPS; rate limit; CORS allow-list

DB:
- PostgreSQL + migrations; index hot columns; avoid N+1; transactions for multi-step writes

Patterns:
- Controllers thin ‚Üí services ‚Üí repositories; error middleware centralized
- n8n: Trigger ‚Üí Fetch ‚Üí Transform ‚Üí Validate ‚Üí Persist ‚Üí Notify with retries/backoff
- UI/UX: KPI cards + trends; clear states; show data freshness

Git:
- Branches feature/*, bugfix/*, release/*; commits conventional (e.g., feat(api): ...)

# ‚ö†Ô∏è CRITICAL: Code Protection Rules

BEFORE MODIFYING ANY CODE:
1. Check for üîí PROTECTED markers
2. Read .cursor/rules/code-preservation.md
3. For bot/AI code, read .cursor/rules/ai-chatbot-rules.md

PROTECTED CODE POLICY:
- üîí PROTECTED sections = DO NOT modify without user approval
- Always ASK before refactoring protected code
- Show changes and wait for confirmation
- Never remove business logic "to simplify"

WHEN USER SAYS "improve" or "refactor":
1. Identify protected sections first
2. Show what you plan to change
3. Explain impact
4. Wait for explicit "yes, proceed"

BOT/AI CODE RULES:
- DO NOT change prompts without testing
- DO NOT simplify RAG logic
- DO NOT remove fallback handling
- DO NOT skip validation
- See .cursor/rules/ai-chatbot-rules.md

SAFE OPERATIONS (no approval needed):
- Add logging/comments
- Fix typos
- Add new features (append only)
- Improve error messages

DANGEROUS (always ask):
- Refactor core logic
- Remove existing code
- Change function signatures
- Modify prompts
- Change API contracts
